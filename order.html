<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>手動訂單收集器</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="p-4 bg-light">

  <h1 class="mb-3 mt-5 text-center">手動訂單收集器</h1>
  <div x-data="textToJsonConverter()" class="container">
    <div class="mb-3 d-flex justify-content-between">
      <button type="button" class="btn btn-primary fs-1" @click="pasteFromClipboard()">貼上</button>
      <button type="button" class="btn btn-danger fs-1" @click="reset()">重置</button>
    </div>


    <textarea x-model="inputText" class="form-control" placeholder="貼上文字格式資料" style="min-height: 60vh;"></textarea>


    <div class="mt-3 d-flex justify-content-center">
      <button class="btn btn-secondary fs-1" @click="sendOrder()">送出訂單</button>
    </div>
  </div>

  <script>
    function textToJsonConverter() {
      return {
        inputText: '',
        jsonOutput: '',
        reset() {
          this.inputText = '';
          this.jsonOutput = '';
        },
        pasteFromClipboard() {
          if (!navigator.clipboard || !navigator.clipboard.readText) {
            return alert('你的瀏覽器不支援 Clipboard API');
          }
          navigator.clipboard.readText()
            .then(text => {
              this.inputText = text;
              // 如有自動縮放或其他邏輯，可手動觸發
              this.adjustFont?.();
            })
            .catch(err => {
              console.error(err);
              alert('讀取剪貼簿失敗：' + err);
            });
        },
        async convert() {
          const lines = this.inputText.split("\n").map(l => l.trim()).filter(l => l !== "");
          const result = {
            date: "",
            partner: "",
            items: []
          };

          for (let line of lines) {
            if (line.startsWith("日期:")) {
              result.date = line.replace("日期:", "").replace(";", "").trim();
            } else if (line.startsWith("成員:")) {
              result.partner = line.replace("成員:", "").replace(";", "").trim();
            } else if (line.startsWith("【")) {
              const match = line.match(/【(.+?)】:(\d+);?/);
              if (match) {
                result.items.push({
                  name: match[1],
                  count: parseInt(match[2])
                });
              }
            }
          }

          this.jsonOutput = JSON.stringify(result, null, 2);
        },
        async sendOrder() {
          await this.convert();
          this.merge(this.jsonOutput);
        },
        async merge(patch) {
          let obj;
          try {
            obj = JSON.parse(patch);
          } catch (e) {
            return;
          }
          try {
            const res = await fetch('/.netlify/functions/updateData', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(obj)
            });
            const result = await res.json();

            if (!res.ok || !result.success) {
              throw new Error(result.message || res.statusText);
            }
            alert('已送出訂單！');
          } catch (e) {
            alert("訂單送出失敗！");
          } finally {
          }
        },



      };
    }
  </script>

</body>

</html>