<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>é›²ç«¯ JSON ç·¨è¼¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    h1 { margin-bottom: 1rem; }
    textarea { 
      width: 100%; 
      height: 300px; 
      font-family: monospace; 
      font-size: 14px; 
      padding: 0.5rem; 
      border: 1px solid #ccc; 
      border-radius: 4px;
      box-sizing: border-box;
    }
    .btn {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.6rem 1.2rem;
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:disabled { background: #a5b4fc; cursor: not-allowed; }
    .status { margin-top: 0.5rem; font-size: 0.9rem; }
  </style>
</head>
<body x-data="jsonEditor()" x-init="load()">

  <h1>é›²ç«¯ JSON ç·¨è¼¯å™¨</h1>

  <!-- JSON ç·¨è¼¯ textarea -->
  <textarea x-model="content"></textarea>

  <!-- æŒ‰éˆ•å€ -->
  <div>
    <button class="btn" :disabled="saving" @click="save()">
      <template x-if="!saving">ğŸ’¾ å­˜å›é›²ç«¯</template>
      <template x-if="saving">â³ å­˜æª”ä¸­...</template>
    </button>
    <button class="btn" style="background:#6b7280" @click="load()">ğŸ”„ é‡æ–°è®€å–</button>
  </div>

  <!-- å„²å­˜ç‹€æ…‹é¡¯ç¤º -->
  <div class="status" x-text="statusMessage"></div>

  <script>
    function jsonEditor() {
      return {
        content: '',           // textarea ç¶å®šçš„æ–‡å­—
        saving: false,         // å­˜æª”ä¸­ç‹€æ…‹
        statusMessage: '',     // ä¸‹æ–¹é¡¯ç¤ºè®€å–ï¼å­˜æª”ç‹€æ…‹

        // è®€å–é›²ç«¯ JSON
        async load() {
          this.statusMessage = 'è®€å–ä¸­â€¦';
          try {
            const res = await fetch('/.netlify/functions/getData');
            if (!res.ok) throw new Error(res.statusText);
            const data = await res.json();
            this.content = JSON.stringify(data, null, 2);
            this.statusMessage = 'âœ… è®€å–å®Œæˆ';
          } catch (e) {
            this.statusMessage = 'âŒ è®€å–å¤±æ•—ï¼š' + e.message;
          }
        },

        // æŠŠ textarea çš„ JSON å­˜å›é›²ç«¯
        async save() {
          let parsed;
          try {
            parsed = JSON.parse(this.content);
          } catch (e) {
            this.statusMessage = 'âŒ JSON æ ¼å¼éŒ¯èª¤ï¼š' + e.message;
            return;
          }

          this.saving = true;
          this.statusMessage = 'å­˜æª”ä¸­â€¦';
          try {
            const res = await fetch('/.netlify/functions/updateData', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(parsed)
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message || res.statusText);
            this.statusMessage = 'âœ… å­˜æª”æˆåŠŸ';
          } catch (e) {
            this.statusMessage = 'âŒ å­˜æª”å¤±æ•—ï¼š' + e.message;
          } finally {
            this.saving = false;
          }
        }
      }
    }
  </script>

</body>
</html>
