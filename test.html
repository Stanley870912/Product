<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <title>JSON 編輯範例</title>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="jsonApp()" x-init="load()">
  <h1>目前資料</h1>
  <pre x-text="JSON.stringify(items, null, 2)"></pre>

  <h2>新增一筆</h2>
  <input type="text" x-model="newText" placeholder='{"foo":"bar"}'/>
  <button @click="add()">Add</button>

  <script>
    function jsonApp() {
      return {
        items: null,
        newText: '',

        async load() {
          const res = await fetch('/.netlify/functions/getData')
          this.items = await res.json()
        },

        async add() {
          let obj
          try {
            obj = JSON.parse(this.newText)
          } catch {
            alert('JSON 解析錯誤！')
            return
          }

          const res = await fetch('/.netlify/functions/updateData', {
            method: 'POST',
            body: JSON.stringify({ newItem: obj }),
          })
          const json = await res.json()
          if (json.success) {
            this.items = json.data
            this.newText = ''
          } else {
            alert('更新失敗：' + json.error)
          }
        },
      }
    }
  </script>
</body>
</html>
