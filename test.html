<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GitHub JSON Merge ç·¨è¼¯å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js" defer></script>
  <style>
    body { font-family:sans-serif; padding:2rem; max-width:700px; margin:auto; }
    pre, textarea { width:100%; box-sizing:border-box; font-family:monospace; }
    pre { height:200px; overflow:auto; background:#f3f4f6; padding:1rem; border-radius:4px; }
    textarea { height:100px; margin-bottom:1rem; padding:.5rem; border:1px solid #ccc; border-radius:4px; }
    button { padding:.6rem 1.2rem; background:#10b981; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button:disabled { background:#6ee7b7; cursor:not-allowed; }
    .status { margin-top:.5rem; font-size:.9rem; }
  </style>
</head>
<body x-data="app()" x-init="load()">

  <h1>GitHub JSON Merge ç·¨è¼¯å™¨</h1>

  <h2>ç›®å‰ content</h2>
  <pre x-text="content"></pre>

  <h2>åˆä½µ JSON ç‰‡æ®µ</h2>
  <textarea x-model="patch" placeholder='ç¯„ä¾‹ï¼š{"newKey":"newValue"}'></textarea>
  <button @click="merge()" :disabled="merging">
    <template x-if="!merging">ğŸ”€ åˆä½µä¸¦å­˜å›</template>
    <template x-if="merging">â³ è™•ç†ä¸­â€¦</template>
  </button>

  <div class="status" x-text="status"></div>

  <script>
    function app() {
      return {
        content: '',    // ç•¶å‰ JSON (å­—ä¸²)
        patch: '',      // ä½¿ç”¨è€…è¼¸å…¥çš„æ–° JSON ç‰‡æ®µ
        status: '',     // æ“ä½œç‹€æ…‹
        merging: false,

        async load() {
          this.status = 'è®€å–ä¸­â€¦';
          try {
            const res = await fetch('/.netlify/functions/getData');
            if (!res.ok) throw new Error(res.statusText);
            this.content = await res.text();
            this.status = 'âœ… è®€å–å®Œæˆ';
          } catch (e) {
            this.status = 'âŒ è®€å–å¤±æ•—ï¼š' + e.message;
          }
        },

        async merge() {
          let obj;
          try {
            obj = JSON.parse(this.patch);
          } catch (e) {
            this.status = 'âŒ JSON ç‰‡æ®µæ ¼å¼éŒ¯èª¤';
            return;
          }
          this.merging = true;
          this.status = 'åˆä½µä¸­â€¦';
          try {
            const res = await fetch('/.netlify/functions/updateData', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(obj)
            });
            const result = await res.json();
            if (!res.ok || !result.success) {
              throw new Error(result.message || res.statusText);
            }
            this.status = 'âœ… åˆä½µä¸¦å­˜å›æˆåŠŸ';
            this.patch = '';
            // é¡¯ç¤ºæœ€æ–°åˆä½µå¾Œçš„ data
            this.content = JSON.stringify(result.data, null, 2);
          } catch (e) {
            this.status = 'âŒ åˆä½µå¤±æ•—ï¼š' + e.message;
          } finally {
            this.merging = false;
          }
        }
      }
    }
  </script>
</body>
</html>
