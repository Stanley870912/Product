<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>出貨單產生器</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    @media print {
      body {
        background-color: white;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
</head>

<body x-data="shippingDocGenerator()" x-init="init()" class="my-3">
  <div class="container">
    <!-- 輸入區域 -->
    <div class="row mb-3 no-print">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white py-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>出貨單產生器</strong>
                <small class="ms-2" x-show="dataLoaded">✓</small>
              </div>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-light btn-sm" @click="pasteFromClipboard()">貼上</button>
                <button class="btn btn-success btn-sm" @click="parseAndLoad()">載入</button>
                <button type="button" class="btn btn-outline-light btn-sm" @click="reset()">重置</button>
              </div>
            </div>
          </div>
          <div class="card-body py-2">
            <textarea x-model="inputText" class="form-control" placeholder="請貼上訂單資料" rows="5" style="font-family: monospace; font-size: 0.9rem;"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- 成員和日期 -->
    <div class="row mb-2" x-show="member || date">
      <div class="col-md-6">
        <strong>成員：</strong><span x-text="member"></span>
      </div>
      <div class="col-md-6">
        <strong>日期：</strong><span x-text="date"></span>
      </div>
    </div>

    <!-- 商品表格 -->
    <template x-if="items.length > 0">
      <div>
        <table class="table table-bordered table-striped">
          <thead class="table-primary text-center">
            <tr>
              <th>品名</th>
              <th style="width: 100px;">數量</th>
              <th style="width: 120px;">小計</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="item in items" :key="item.name">
              <tr class="text-center">
                <td class="text-start" x-text="item.name"></td>
                <td x-text="item.count"></td>
                <td x-text="item.subtotal.toFixed(2)"></td>
              </tr>
            </template>
          </tbody>
          <tfoot>
            <tr class="table-info text-end">
              <td colspan="2"><strong>總金額</strong></td>
              <td class="text-center">
                <strong x-text="total.toFixed(2)"></strong>
              </td>
            </tr>
          </tfoot>
        </table>

        <!-- 功能按鈕 -->
        <div class="mt-4 d-flex gap-2 no-print">
          <button class="btn btn-success" @click="window.print()">列印</button>
          <button class="btn btn-info" @click="copyDocument()">複製</button>
        </div>
      </div>
    </template>
  </div>

  <script>
    function shippingDocGenerator() {
      return {
        inputText: '',
        member: '',
        date: '',
        items: [],
        total: 0,
        productData: [],
        dataLoaded: false,
        loadError: false,

        async init() {
          try {
            const res = await fetch('non_pickup.json');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            this.productData = await res.json();
            this.dataLoaded = true;
            console.log('產品資料載入成功，共', this.productData.length, '項');
          } catch (error) {
            console.error('無法載入產品資料:', error);
            this.loadError = true;
            alert('無法載入產品資料。\n請確認此頁面是透過本地伺服器開啟（如 Live Server）。');
          }
        },

        reset() {
          this.inputText = '';
          this.member = '';
          this.date = '';
          this.items = [];
          this.total = 0;
        },

        pasteFromClipboard() {
          if (!navigator.clipboard?.readText) {
            return alert('你的瀏覽器不支援 Clipboard API');
          }
          navigator.clipboard.readText()
            .then(text => this.inputText = text)
            .catch(err => {
              console.error(err);
              alert('讀取剪貼簿失敗：' + err);
            });
        },

        parseAndLoad() {
          if (!this.inputText.trim()) {
            alert('請先輸入或貼上訂單資料');
            return;
          }

          if (!this.dataLoaded || this.productData.length === 0) {
            alert('產品資料尚未載入，請稍候再試或重新整理頁面');
            return;
          }

          const DATE_RE = /^日期:(.+?);?$/;
          const MEMBER_RE = /^成員:(.+?);?$/;
          const ITEM_RE = /^【(.+?)】:(\d+);?$/;
          const TOTAL_RE = /^總金額:\s*([\d.]+)元;?$/;
          const CAT_RE = /^(.+?):([\d.]+)元;?$/;

          const data = {
            member: '',
            date: '',
            items: [],
            total: 0
          };

          const lines = this.inputText
            .split('\n')
            .map(l => l.trim())
            .filter(Boolean);

          lines.forEach(line => {
            let match;

            if (DATE_RE.test(line)) {
              [, match] = DATE_RE.exec(line);
              data.date = match.trim();
            } else if (MEMBER_RE.test(line)) {
              [, match] = MEMBER_RE.exec(line);
              data.member = match.trim();
            } else if (ITEM_RE.test(line)) {
              const [, name, countStr] = ITEM_RE.exec(line);
              const count = Number(countStr);
              
              const product = this.productData.find(p => p.product_name === name.trim());
              const price = product ? product.price : 0;
              const subtotal = count * price;
              
              data.items.push({
                name: name.trim(),
                count: count,
                price: price,
                subtotal: subtotal
              });
            } else if (TOTAL_RE.test(line)) {
              const [, totalStr] = TOTAL_RE.exec(line);
              data.total = Number(totalStr);
            } else if (CAT_RE.test(line)) {
              return;
            }
          });

          if (!data.member) {
            alert('找不到成員資訊\n請確認格式：成員:XXX');
            return;
          }

          if (!data.date) {
            alert('找不到日期資訊\n請確認格式：日期:YYYY-MM-DD');
            return;
          }

          if (data.items.length === 0) {
            alert('找不到商品資訊\n請確認格式：【商品名稱】:數量');
            return;
          }

          this.member = data.member;
          this.date = data.date;
          this.items = data.items;
          
          if (data.total === 0) {
            this.total = data.items.reduce((sum, item) => sum + item.subtotal, 0);
          } else {
            this.total = data.total;
          }

          console.log('載入成功:', { member: this.member, date: this.date, items: this.items.length, total: this.total });
        },

        async copyDocument() {
          let text = '出 貨 單\n\n';
          text += `成員：${this.member}\n`;
          text += `日期：${this.date}\n\n`;
          text += '品名\t\t數量\t小計\n';
          text += '─'.repeat(40) + '\n';
          this.items.forEach(item => {
            text += `${item.name}\t\t${item.count}\t${item.subtotal.toFixed(2)}\n`;
          });
          text += '─'.repeat(40) + '\n';
          text += `總金額：${this.total.toFixed(2)} 元\n`;

          try {
            await navigator.clipboard.writeText(text);
            alert('出貨單已複製到剪貼簿');
          } catch (err) {
            console.error(err);
            alert('複製失敗：' + err.message);
          }
        }
      };
    }
  </script>
</body>

</html>
